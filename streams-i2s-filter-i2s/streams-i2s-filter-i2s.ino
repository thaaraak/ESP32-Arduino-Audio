/**
 * @file streams-i2s-filter-i2s.ino
 * @brief Copy audio from I2S to I2S using an FIR filter
 * @author Phil Schatzmann
 * @copyright GPLv3
 */

#include "AudioTools.h"
 
uint16_t sample_rate=44100;
uint16_t channels = 2;
I2SStream in;

// define FIR filter parameters


float coef[] = { 
-0.001391763914244106,
 0.001103556321305671,
 0.004372181047192498,
 0.008411669043282964,
 0.013177402704447911,
 0.018580962742156572,
 0.024491287058198977,
 0.030738712671274517,
 0.037121787339982948,
 0.043416524885351138,
 0.049387582646537809,
 0.054800677567512397,
 0.059435443285980480,
 0.063097874773541618,
 0.065631515382980343,
 0.066926614160945530,
 0.066926614160945530,
 0.065631515382980343,
 0.063097874773541618,
 0.059435443285980480,
 0.054800677567512397,
 0.049387582646537809,
 0.043416524885351138,
 0.037121787339982948,
 0.030738712671274517,
 0.024491287058198977,
 0.018580962742156572,
 0.013177402704447911,
 0.008411669043282964,
 0.004372181047192498,
 0.001103556321305671,
-0.001391763914244106

};

float coef_identity[] = {
1.0, 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
};

float coef_8000Hz[] = {
   0.004562944656565404,
-0.005222452291831093,
-0.014231668853163525,
-0.015026812318186908,
-0.004214652489295785,
 0.013596643543439473,
 0.026809232570857995,
 0.023450273022496894,
 60.50609266750997510E-6,
-0.032884420755125279,
-0.053598944185955316,
-0.039696761151204449,
 0.018307232213949993,
 0.108629682736566244,
 0.200782527076121514,
 0.258848491776393685,
 0.258848491776393685,
 0.200782527076121514,
 0.108629682736566244,
 0.018307232213949993,
-0.039696761151204449,
-0.053598944185955316,
-0.032884420755125279,
 60.50609266750997510E-6,
 0.023450273022496894,
 0.026809232570857995,
 0.013596643543439473,
-0.004214652489295785,
-0.015026812318186908,
-0.014231668853163525,
-0.005222452291831093,
 0.004562944656565404


};


float coeffs_60plus45[60] =
{
     0.004621015177093199,
     0.005803076057134736,
     0.008398848534014810,
     0.011070605501422921,
     0.012011544037449230,
     0.010212483927766067,
     0.006468230078269678,
     0.003276685410765598,
     0.003421402894455017,
     0.007976926394432645,
     0.015086517251198047,
     0.020602093602433549,
     0.020553118230563584,
     0.014069048704528873,
     0.004749834871128875,
    -0.000842860122019913,
     0.002859371099914513,
     0.016274028687678372,
     0.033160109747664451,
     0.043383049674853250,
     0.039014316921656009,
     0.020423745832596006,
    -0.001614427587024464,
    -0.009963364302439288,
     0.009994589273862787,
     0.061109944842178014,
     0.130195753590080343,
     0.191869213030050390,
     0.219369776452719017,
     0.197227986103014563,
     0.129280688421556683,
     0.037690449757477727,
    -0.046755270382402625,
    -0.098240151525143468,
    -0.106623328365524572,
    -0.080149105724243566,
    -0.039387167980812265,
    -0.006148067870983963,
     0.006632322465463789,
    -0.000859139466368104,
    -0.018244181532151575,
    -0.032471581746266860,
    -0.035274696600922327,
    -0.026638667871024192,
    -0.013113047257170066,
    -0.002815732303918569,
    -0.000505099571022141,
    -0.005489290956139294,
    -0.013054185024661442,
    -0.017950908774627395,
    -0.017543003217475647,
    -0.012834680480806963,
    -0.007166192548587818,
    -0.003783981742332182,
    -0.003943651197459626,
    -0.006576238628670079,
    -0.009410544263128996,
    -0.010581789452050234,
    -0.009650968000300929,
    -0.007537225770687841
};

float coeffs_60minus45[60] =
{
    -0.007537225770687170,
    -0.009650968000300499,
    -0.010581789452050476,
    -0.009410544263129985,
    -0.006576238628671330,
    -0.003943651197460286,
    -0.003783981742331553,
    -0.007166192548585905,
    -0.012834680480804665,
    -0.017543003217474328,
    -0.017950908774628013,
    -0.013054185024663774,
    -0.005489290956141837,
    -0.000505099571022898,
    -0.002815732303916365,
    -0.013113047257165571,
    -0.026638667871019869,
    -0.035274696600921071,
    -0.032471581746270073,
    -0.018244181532157757,
    -0.000859139466373159,
     0.006632322465464511,
    -0.006148067870975227,
    -0.039387167980797798,
    -0.080149105724229994,
    -0.106623328365520187,
    -0.098240151525153974,
    -0.046755270382427966,
     0.037690449757444351,
     0.129280688421526124,
     0.197227986102997105,
     0.219369776452719767,
     0.191869213030067154,
     0.130195753590105073,
     0.061109944842200607,
     0.009994589273875859,
    -0.009963364302437662,
    -0.001614427587030836,
     0.020423745832587811,
     0.039014316921651394,
     0.043383049674854284,
     0.033160109747669607,
     0.016274028687684093,
     0.002859371099917639,
    -0.000842860122020447,
     0.004749834871125916,
     0.014069048704525876,
     0.020553118230562491,
     0.020602093602434816,
     0.015086517251200629,
     0.007976926394434900,
     0.003421402894455769,
     0.003276685410764736,
     0.006468230078268022,
     0.010212483927764715,
     0.012011544037448875,
     0.011070605501423535,
     0.008398848534015839,
     0.005803076057135559,
     0.004621015177093499

};

#define FIR_LEN 160

float coeffs_plus45[FIR_LEN] =
{
     461.3631158124100E-9,
     1.880075035958710E-6,
     4.244688443739260E-6,
     7.619681390367910E-6,
     0.000012313367447137,
     0.000018773079572471,
     0.000027210903090093,
     0.000037339661945783,
     0.000048618618238189,
     0.000060917311288032,
     0.000074940822081461,
     0.000091802017965105,
     0.000111952353786665,
     0.000134574442773098,
     0.000158427039879070,
     0.000183740248736192,
     0.000213228734927988,
     0.000250397470075127,
     0.000295664030520189,
     0.000343702375679203,
     0.000385796372285749,
     0.000417344961185557,
     0.000445185099035797,
     0.000487110621681180,
     0.000560514464536730,
     0.000666518364966606,
     0.000782741355728304,
     0.000874472108222985,
     0.000920306036438336,
     0.000933955966360160,
     0.000962118395328380,
     0.001054182470027126,
     0.001223354526588638,
     0.001430734462003340,
     0.001610283277419377,
     0.001719952380259197,
     0.001778135203213578,
     0.001850574456628051,
     0.001992459295044653,
     0.002193989241841364,
     0.002384559309378090,
     0.002505140235114932,
     0.002590913468287812,
     0.002776974817514604,
     0.003189560019761867,
     0.003790282497249595,
     0.004316866043242614,
     0.004426652007085084,
     0.003994092572090826,
     0.003344880135505250,
     0.003179422680206599,
     0.004123844774689084,
     0.006156317448625263,
     0.008359208399519001,
     0.009331060317025122,
     0.008151877744547217,
     0.005298718038545408,
     0.002751393951505030,
     0.002941281587814315,
     0.007012478488408471,
     0.013546427534223580,
     0.018873384442122498,
     0.019187912400517801,
     0.013370293085035838,
     0.004589874132080914,
    -0.000827272528716105,
     0.002847499891668613,
     0.016425620103753074,
     0.033885458231380131,
     0.044836205566751330,
     0.040736897466057354,
     0.021522916911347216,
    -0.001715280806970787,
    -0.010661662945769042,
     0.010760673430067827,
     0.066129749045279865,
     0.141464857790828596,
     0.209113066971534201,
     0.239571402135733441,
     0.215609424313158826,
     0.141329510867801988,
     0.041161339732100705,
    -0.050957304886721261,
    -0.106743335950956308,
    -0.115381775673245840,
    -0.086292525763515982,
    -0.042147681912724659,
    -0.006532137398921158,
     0.006989262720142971,
    -0.000897072641839686,
    -0.018855287484476346,
    -0.033181869280377425,
    -0.035603277882912322,
    -0.026528072511890932,
    -0.012870538634115823,
    -0.002720906561020903,
    -0.000480013215073879,
    -0.005124674165048443,
    -0.011958816288453879,
    -0.016118410951980158,
    -0.015421971646935111,
    -0.011033605380079165,
    -0.006017367052914016,
    -0.003099805058416487,
    -0.003147927835795416,
    -0.005108692030929120,
    -0.007105727020828476,
    -0.007756403128060120,
    -0.006858275433043922,
    -0.005185879215449126,
    -0.003751801893335123,
    -0.003128953444558723,
    -0.003237421371096828,
    -0.003598506965272457,
    -0.003760065064447528,
    -0.003569663436844562,
    -0.003164175002598923,
    -0.002771235284269221,
    -0.002517345092816231,
    -0.002374938429607430,
    -0.002242784472799805,
    -0.002058216791428786,
    -0.001844095128253326,
    -0.001669473092167466,
    -0.001576370696429601,
    -0.001540862844099931,
    -0.001495606378085042,
    -0.001386603128463033,
    -0.001214076170942454,
    -0.001027521609543527,
    -0.000884830011465821,
    -0.000810929396580170,
    -0.000785968422661929,
    -0.000766376467687636,
    -0.000717954886486168,
    -0.000635733715777003,
    -0.000539905782448249,
    -0.000456186303705258,
    -0.000397755847649209,
    -0.000360548391694147,
    -0.000331312248939032,
    -0.000299179720639043,
    -0.000261739561889203,
    -0.000223216286749154,
    -0.000188736634665402,
    -0.000160185076583033,
    -0.000136119727636672,
    -0.000114301174336721,
    -0.000093861507549156,
    -0.000075460382548635,
    -0.000060001084606378,
    -0.000047515938112403,
    -0.000037176105230435,
    -0.000028097318386011,
    -0.000019994911849510,
    -0.000013142882838656,
    -7.870967761253990E-6,
    -4.183764856277620E-6,
    -1.802515539663780E-6,
    -446.6172729366020E-9
};

float coeffs_minus45[FIR_LEN] =
{
    -446.6172729366680E-9,
    -1.802515539664060E-6,
    -4.183764856278170E-6,
    -7.870967761254600E-6,
    -0.000013142882838656,
    -0.000019994911849509,
    -0.000028097318386008,
    -0.000037176105230431,
    -0.000047515938112396,
    -0.000060001084606372,
    -0.000075460382548631,
    -0.000093861507549157,
    -0.000114301174336727,
    -0.000136119727636684,
    -0.000160185076583047,
    -0.000188736634665414,
    -0.000223216286749160,
    -0.000261739561889200,
    -0.000299179720639031,
    -0.000331312248939012,
    -0.000360548391694120,
    -0.000397755847649178,
    -0.000456186303705228,
    -0.000539905782448231,
    -0.000635733715777009,
    -0.000717954886486206,
    -0.000766376467687703,
    -0.000785968422662003,
    -0.000810929396580225,
    -0.000884830011465832,
    -0.001027521609543487,
    -0.001214076170942378,
    -0.001386603128462947,
    -0.001495606378084967,
    -0.001540862844099874,
    -0.001576370696429555,
    -0.001669473092167430,
    -0.001844095128253315,
    -0.002058216791428819,
    -0.002242784472799886,
    -0.002374938429607525,
    -0.002517345092816282,
    -0.002771235284269179,
    -0.003164175002598794,
    -0.003569663436844421,
    -0.003760065064447462,
    -0.003598506965272495,
    -0.003237421371096883,
    -0.003128953444558641,
    -0.003751801893334809,
    -0.005185879215448678,
    -0.006858275433043632,
    -0.007756403128060317,
    -0.007105727020829240,
    -0.005108692030930105,
    -0.003147927835795951,
    -0.003099805058415979,
    -0.006017367052912424,
    -0.011033605380077216,
    -0.015421971646933987,
    -0.016118410951980754,
    -0.011958816288456041,
    -0.005124674165050830,
    -0.000480013215074600,
    -0.002720906561018780,
    -0.012870538634111443,
    -0.026528072511886689,
    -0.035603277882911136,
    -0.033181869280380791,
    -0.018855287484482786,
    -0.000897072641844965,
     0.006989262720143749,
    -0.006532137398911892,
    -0.042147681912709283,
    -0.086292525763501576,
    -0.115381775673241371,
    -0.106743335950967994,
    -0.050957304886748996,
     0.041161339732064352,
     0.141329510867768932,
     0.215609424313140285,
     0.239571402135734829,
     0.209113066971552936,
     0.141464857790855797,
     0.066129749045304484,
     0.010760673430081927,
    -0.010661662945767326,
    -0.001715280806977562,
     0.021522916911338633,
     0.040736897466052635,
     0.044836205566752510,
     0.033885458231385474,
     0.016425620103758889,
     0.002847499891671732,
    -0.000827272528716631,
     0.004589874132078064,
     0.013370293085033021,
     0.019187912400516826,
     0.018873384442123702,
     0.013546427534225932,
     0.007012478488410471,
     0.002941281587814968,
     0.002751393951504313,
     0.005298718038544065,
     0.008151877744546157,
     0.009331060317024867,
     0.008359208399519485,
     0.006156317448626034,
     0.004123844774689679,
     0.003179422680206813,
     0.003344880135505174,
     0.003994092572090685,
     0.004426652007085053,
     0.004316866043242711,
     0.003790282497249726,
     0.003189560019761925,
     0.002776974817514559,
     0.002590913468287710,
     0.002505140235114852,
     0.002384559309378082,
     0.002193989241841426,
     0.001992459295044749,
     0.001850574456628144,
     0.001778135203213653,
     0.001719952380259258,
     0.001610283277419427,
     0.001430734462003371,
     0.001223354526588636,
     0.001054182470027082,
     0.000962118395328303,
     0.000933955966360077,
     0.000920306036438278,
     0.000874472108222970,
     0.000782741355728332,
     0.000666518364966660,
     0.000560514464536788,
     0.000487110621681227,
     0.000445185099035825,
     0.000417344961185568,
     0.000385796372285748,
     0.000343702375679193,
     0.000295664030520174,
     0.000250397470075110,
     0.000213228734927974,
     0.000183740248736184,
     0.000158427039879069,
     0.000134574442773105,
     0.000111952353786676,
     0.000091802017965117,
     0.000074940822081470,
     0.000060917311288037,
     0.000048618618238190,
     0.000037339661945781,
     0.000027210903090091,
     0.000018773079572469,
     0.000012313367447136,
     7.619681390366950E-6,
     4.244688443738930E-6,
     1.880075035958700E-6,
     461.3631158124420E-9

};

float coeffs_hpf_2205Hz_60_44100 [] = {
   21.81650012186714350E-6,
-26.76839616552976860E-6,
-229.0366116413808580E-6,
-604.8313479737554420E-6,
-0.001146924558045816,
-0.001814684043679535,
-0.002531295147075938,
-0.003185602761526598,
-0.003639184951682374,
-0.003738677225901633,
-0.003332701307174086,
-0.002292095486947753,
-531.5840255548182540E-6,
 0.001969353952539947,
 0.005148778160858297,
 0.008849923556501179,
 0.012815848667586293,
 0.016691923127677356,
 0.020035813219273412,
 0.022333102329396642,
 0.023014663527758154,
 0.021468916263668769,
 0.017036815441032117,
 0.008966043549558243,
-0.003728189624613387,
-0.022635201990406573,
-0.051004143960547095,
-0.097365687254872990,
-0.193638448211825964,
-0.630329295556546487,
 0.630329295556546487,
 0.193638448211825964,
 0.097365687254872990,
 0.051004143960547095,
 0.022635201990406573,
 0.003728189624613387,
-0.008966043549558243,
-0.017036815441032117,
-0.021468916263668769,
-0.023014663527758154,
-0.022333102329396642,
-0.020035813219273412,
-0.016691923127677356,
-0.012815848667586293,
-0.008849923556501179,
-0.005148778160858297,
-0.001969353952539947,
 531.5840255548182540E-6,
 0.002292095486947753,
 0.003332701307174086,
 0.003738677225901633,
 0.003639184951682374,
 0.003185602761526598,
 0.002531295147075938,
 0.001814684043679535,
 0.001146924558045816,
 604.8313479737554420E-6,
 229.0366116413808580E-6,
 26.76839616552976860E-6,
-21.81650012186714350E-6


};


float coeffs_lpf_2205Hz_60_44100 [] = {
  -96.37464579060073790E-6,
-239.5922410224250710E-6,
-236.3866644854411160E-6,
-2.158076902079195220E-6,
 510.2559562923468660E-6,
 0.001286383953416845,
 0.002234094331159058,
 0.003181184355529571,
 0.003890215348743426,
 0.004091359454488967,
 0.003530532804035990,
 0.002026581946409395,
-471.5498250157864960E-6,
-0.003838285809652535,
-0.007745892812315048,
-0.011668195105453104,
-0.014917825986515122,
-0.016716148646595486,
-0.016289357550435389,
-0.012979146956684395,
-0.006352643733446109,
 0.003705193386918102,
 0.016932376001823603,
 0.032675798700162108,
 0.049928231758077674,
 0.067415089353529495,
 0.083722175327715726,
 0.097449098668476702,
 0.107368611573056216,
 0.112570535158906665,
 0.112570535158906665,
 0.107368611573056216,
 0.097449098668476702,
 0.083722175327715726,
 0.067415089353529495,
 0.049928231758077674,
 0.032675798700162108,
 0.016932376001823603,
 0.003705193386918102,
-0.006352643733446109,
-0.012979146956684395,
-0.016289357550435389,
-0.016716148646595486,
-0.014917825986515122,
-0.011668195105453104,
-0.007745892812315048,
-0.003838285809652535,
-471.5498250157864960E-6,
 0.002026581946409395,
 0.003530532804035990,
 0.004091359454488967,
 0.003890215348743426,
 0.003181184355529571,
 0.002234094331159058,
 0.001286383953416845,
 510.2559562923468660E-6,
-2.158076902079195220E-6,
-236.3866644854411160E-6,
-239.5922410224250710E-6,
-96.37464579060073790E-6

};

// copy filtered values
FilteredStream<int16_t, float> filtered(in, channels);  // Defiles the filter as BaseConverter
StreamCopy copier(in, filtered, 512);               // copies sound into i2s

int overall_loopcount = 0;

// Arduino Setup
void setup(void) {  
  // Open Serial 

pinMode(26, OUTPUT);
pinMode(27, OUTPUT);

  Serial.begin(115200);
  // change to Warning to improve the quality
  AudioLogger::instance().begin(Serial, AudioLogger::Error); 



/*
  // high pass / low pass filter at 2.205 KHz 60 taps
  filtered.setFilter(0, new FIR<float>(coeffs_lpf_2205Hz_60_44100));
  filtered.setFilter(1, new FIR<float>(coeffs_hpf_2205Hz_60_44100));
*/


  // 90 degree phase shift 160 taps (~4.5 KHz cutoff)
  filtered.setFilter(0, new FIR<float>(coeffs_plus45));
  filtered.setFilter(1, new FIR<float>(coeffs_minus45));


  // start I2S in
  Serial.println("starting I2S...");
  // start I2S in
  auto config = in.defaultConfig(RXTX_MODE);
  config.sample_rate = sample_rate;
  config.bits_per_sample = 16;
  config.i2s_format = I2S_STD_FORMAT;
  config.is_master = true;
  config.port_no = 0;
  config.pin_ws = 18;
  config.pin_bck = 5;
  config.pin_data = 19;
  config.pin_data_rx = 17;
  config.pin_mck = 0;
  config.use_apll = true;
  in.begin(config);

  Serial.println("I2S started...");
}

// Arduino loop - copy sound to out 
void loop() {
  overall_loopcount++;
  copier.copy();
}
